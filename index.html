<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ImageHub | Professional Cloud</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/cloud.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts: Inter (The gold standard for UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1', // Indigo 500
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                        dark: {
                            bg: '#0f172a', // Slate 900
                            surface: '#1e293b', // Slate 800
                            border: '#334155', // Slate 700
                        }
                    },
                    boxShadow: {
                        'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025)',
                        'nav': '0 -4px 6px -1px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .dark body {
            background-image: radial-gradient(#334155 1px, transparent 1px);
        }

        /* Smooth Transitions */
        * {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sidebar Nav Item Active State */
        .desktop-nav .nav-item.active {
            background-color: #f1f5f9;
            color: #4f46e5;
            border-right: 3px solid #4f46e5;
        }
        .dark .desktop-nav .nav-item.active {
            background-color: #1e293b;
            color: #818cf8;
            border-right: 3px solid #818cf8;
        }
        .desktop-nav .nav-item {
            border-right: 3px solid transparent;
        }

        /* Mobile Bottom Nav Active State */
        .mobile-nav .nav-item.active {
            color: #4f46e5;
        }
        .dark .mobile-nav .nav-item.active {
            color: #818cf8;
        }
        .mobile-nav .nav-item.active i {
            font-weight: bold;
        }

        /* Animations Stagger */
        .stagger-1 { animation-delay: 50ms; }
        .stagger-2 { animation-delay: 100ms; }
        .stagger-3 { animation-delay: 150ms; }
        .stagger-4 { animation-delay: 200ms; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg h-screen w-full flex overflow-hidden text-slate-600 dark:text-slate-300 selection:bg-brand-500 selection:text-white">

    <!-- Sidebar (Desktop) -->
    <aside class="w-64 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md border-r border-slate-200 dark:border-dark-border flex-col z-20 hidden md:flex shadow-subtle">
        <div class="p-6 desktop-nav">
            <div class="flex items-center gap-3 mb-8 px-2">
                <div class="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center text-white shadow-md">
                    <i class="ph-bold ph-cloud text-lg"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">ImageHub</h1>
            </div>

            <div class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Overview</div>
            
            <nav class="space-y-1">
                <button onclick="window.router('dashboard')" id="desk-nav-dashboard" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md hover:bg-slate-50 dark:hover:bg-dark-surface/50 hover:text-slate-900 dark:hover:text-white transition-all group">
                    <i class="ph ph-squares-four text-lg"></i>
                    Dashboard
                </button>
                <button onclick="window.router('upload')" id="desk-nav-upload" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md hover:bg-slate-50 dark:hover:bg-dark-surface/50 hover:text-slate-900 dark:hover:text-white transition-all group">
                    <i class="ph ph-upload-simple text-lg"></i>
                    Upload
                </button>
                <button onclick="window.router('gallery')" id="desk-nav-gallery" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md hover:bg-slate-50 dark:hover:bg-dark-surface/50 hover:text-slate-900 dark:hover:text-white transition-all group">
                    <i class="ph ph-images text-lg"></i>
                    Gallery
                </button>
                <button onclick="window.router('sections')" id="desk-nav-sections" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md hover:bg-slate-50 dark:hover:bg-dark-surface/50 hover:text-slate-900 dark:hover:text-white transition-all group">
                    <i class="ph ph-folders text-lg"></i>
                    Sections
                </button>
            </nav>

            <div class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mt-8 mb-2 px-3">Settings</div>
            
            <nav class="space-y-1">
                <button onclick="window.router('settings')" id="desk-nav-settings" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-md hover:bg-slate-50 dark:hover:bg-dark-surface/50 hover:text-slate-900 dark:hover:text-white transition-all group">
                    <i class="ph ph-gear text-lg"></i>
                    Preferences
                </button>
            </nav>
        </div>

        <div class="mt-auto p-4 border-t border-slate-200 dark:border-dark-border">
            <div class="bg-slate-50 dark:bg-dark-surface rounded-lg p-3 border border-slate-100 dark:border-dark-border">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Storage</span>
                    <span id="storage-text" class="text-[10px] font-bold text-brand-600 dark:text-brand-400">0 MB</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-brand-500 h-full w-2 rounded-full"></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Mobile Header (Top Bar) -->
    <div class="md:hidden fixed top-0 w-full bg-white/90 dark:bg-dark-bg/90 backdrop-blur-md border-b border-slate-200 dark:border-dark-border z-30 flex items-center justify-between p-3 px-4 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 rounded bg-brand-600 flex items-center justify-center text-white">
                <i class="ph-bold ph-cloud text-base"></i>
            </div>
            <span class="font-bold text-base text-slate-900 dark:text-white">ImageHub</span>
        </div>
        <button onclick="window.router('settings')" class="text-slate-500 dark:text-slate-400 p-2 rounded-md active:bg-slate-100 dark:active:bg-dark-surface">
            <i class="ph ph-gear text-xl"></i>
        </button>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 w-full bg-white dark:bg-dark-surface border-t border-slate-200 dark:border-dark-border z-40 shadow-nav mobile-nav">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="window.router('dashboard')" id="mob-nav-dashboard" class="nav-item flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
                <i class="ph ph-squares-four text-2xl"></i>
                <span class="text-[10px] font-medium">Home</span>
            </button>
            <button onclick="window.router('gallery')" id="mob-nav-gallery" class="nav-item flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
                <i class="ph ph-images text-2xl"></i>
                <span class="text-[10px] font-medium">Gallery</span>
            </button>
            <button onclick="window.router('upload')" id="mob-nav-upload" class="nav-item relative -top-5 flex flex-col items-center justify-center">
                <div class="w-14 h-14 rounded-full bg-brand-600 text-white shadow-lg flex items-center justify-center border-4 border-slate-50 dark:border-dark-bg transform transition-transform active:scale-95">
                    <i class="ph-bold ph-plus text-2xl"></i>
                </div>
            </button>
            <button onclick="window.router('sections')" id="mob-nav-sections" class="nav-item flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
                <i class="ph ph-folders text-2xl"></i>
                <span class="text-[10px] font-medium">Folders</span>
            </button>
            <button onclick="window.router('settings')" id="mob-nav-settings" class="nav-item flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
                <i class="ph ph-user text-2xl"></i>
                <span class="text-[10px] font-medium">Profile</span>
            </button>
        </div>
    </div>

    <!-- Content Area -->
    <main class="flex-1 overflow-y-auto pt-16 pb-24 md:pt-0 md:pb-0 relative z-10 bg-slate-50/50 dark:bg-dark-bg">
        <div class="p-6 md:p-10 max-w-7xl mx-auto">

            <!-- DASHBOARD VIEW -->
            <section id="view-dashboard" class="animate-slide-up">
                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Dashboard</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Overview of your assets and activity.</p>
                    </div>
                    <button onclick="window.router('upload')" class="hidden md:flex bg-brand-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium hover:bg-brand-700 shadow-sm transition-all items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Upload Media
                    </button>
                </header>

                <!-- Cards Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Stat Cards... (Same as before) -->
                    <div class="bg-white dark:bg-dark-surface p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-card hover:shadow-float transition-all duration-300 stagger-1">
                        <div class="flex justify-between items-start mb-3">
                            <div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400"><i class="ph-fill ph-image text-xl"></i></div>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-0.5" id="stat-total-images">0</h3>
                        <p class="text-xs font-medium text-slate-500">Total Images</p>
                    </div>
                    <div class="bg-white dark:bg-dark-surface p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-card hover:shadow-float transition-all duration-300 stagger-2">
                        <div class="flex justify-between items-start mb-3">
                            <div class="p-2 rounded-lg bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400"><i class="ph-fill ph-eye text-xl"></i></div>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-0.5" id="stat-total-views">0</h3>
                        <p class="text-xs font-medium text-slate-500">Total Views</p>
                    </div>
                    <div class="bg-white dark:bg-dark-surface p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-card hover:shadow-float transition-all duration-300 stagger-3">
                        <div class="flex justify-between items-start mb-3">
                            <div class="p-2 rounded-lg bg-violet-50 dark:bg-violet-500/10 text-violet-600 dark:text-violet-400"><i class="ph-fill ph-hard-drives text-xl"></i></div>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-0.5" id="stat-storage">0 MB</h3>
                        <p class="text-xs font-medium text-slate-500">Cloud Storage</p>
                    </div>
                    <div class="bg-white dark:bg-dark-surface p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-card hover:shadow-float transition-all duration-300 stagger-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="p-2 rounded-lg bg-amber-50 dark:bg-amber-500/10 text-amber-600 dark:text-amber-400"><i class="ph-fill ph-folders text-xl"></i></div>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-0.5" id="stat-sections">0</h3>
                        <p class="text-xs font-medium text-slate-500">Active Sections</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-dark-surface p-6 rounded-xl border border-slate-200 dark:border-dark-border shadow-card lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white">Engagement Activity</h3>
                        </div>
                        <div class="h-64 w-full"><canvas id="viewsChart"></canvas></div>
                    </div>
                    <div class="bg-white dark:bg-dark-surface p-6 rounded-xl border border-slate-200 dark:border-dark-border shadow-card flex flex-col justify-between">
                        <div>
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-6">Storage Distribution</h3>
                            <div class="h-48 flex items-center justify-center relative">
                                <canvas id="storageChart"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="text-center">
                                        <span class="block text-[10px] text-slate-400 font-bold uppercase">Total</span>
                                        <span class="block text-lg font-bold text-slate-900 dark:text-white" id="chart-center-text">100%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- UPLOAD VIEW -->
            <section id="view-upload" class="hidden max-w-4xl mx-auto animate-slide-up">
                <header class="mb-8 text-center">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Upload Files</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Add new content to your repository.</p>
                </header>
                <div class="bg-white dark:bg-dark-surface rounded-xl shadow-card border border-slate-200 dark:border-dark-border overflow-hidden">
                    <div class="p-8">
                        <div id="drop-zone" class="relative group rounded-xl border-2 border-dashed border-slate-300 dark:border-dark-border hover:border-brand-500 dark:hover:border-brand-500 transition-all duration-300 h-72 flex flex-col items-center justify-center cursor-pointer bg-slate-50 dark:bg-dark-bg overflow-hidden">
                            <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                            <div id="upload-placeholder" class="text-center transition-transform duration-300 group-hover:-translate-y-1 pointer-events-none">
                                <div class="w-16 h-16 bg-brand-50 dark:bg-brand-900/20 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-600 dark:text-brand-400"><i class="ph-fill ph-cloud-arrow-up text-3xl"></i></div>
                                <h3 class="text-base font-semibold text-slate-900 dark:text-white mb-1">Drag files here</h3>
                                <p class="text-xs text-slate-500">or click to browse</p>
                            </div>
                            <div id="upload-preview" class="hidden absolute inset-0 bg-slate-50 dark:bg-dark-bg z-10 flex flex-col">
                                <div class="p-3 border-b border-slate-200 dark:border-dark-border flex justify-between items-center bg-white dark:bg-dark-surface">
                                    <span class="text-xs font-bold text-slate-700 dark:text-white flex items-center gap-2"><i class="ph-fill ph-check-circle text-emerald-500"></i> Queue: <span id="selected-count">0</span></span>
                                    <button onclick="window.resetUpload()" class="text-xs font-bold text-red-500 hover:text-red-600 px-3 py-1.5 rounded hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors uppercase">Clear</button>
                                </div>
                                <div id="preview-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
                            </div>
                            <div id="upload-loading" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/95 dark:bg-dark-surface/95 backdrop-blur-sm">
                                <div class="w-10 h-10 rounded-full border-2 border-brand-500 border-t-transparent animate-spin mb-4"></div>
                                <p id="upload-status-text" class="font-bold text-sm text-slate-700 dark:text-white">Uploading...</p>
                                <div class="w-48 h-1 bg-slate-200 dark:bg-dark-border rounded-full mt-3 overflow-hidden"><div id="upload-progress-bar" class="h-full bg-brand-600 w-0 transition-all duration-300"></div></div>
                            </div>
                        </div>
                        <div class="mt-6 grid md:grid-cols-2 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 uppercase ml-1">Title Prefix</label>
                                <div class="relative"><input type="text" id="upload-title" placeholder="Optional Prefix" class="w-full bg-white dark:bg-dark-bg border border-slate-300 dark:border-dark-border rounded-lg px-4 py-2.5 focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all text-sm"></div>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 uppercase ml-1">Collection</label>
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <select id="upload-section-select" class="w-full bg-white dark:bg-dark-bg border border-slate-300 dark:border-dark-border rounded-lg px-4 py-2.5 focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 text-sm appearance-none cursor-pointer"></select>
                                        <i class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                                    </div>
                                    <button onclick="window.router('sections')" class="bg-slate-100 dark:bg-dark-bg hover:bg-slate-200 dark:hover:bg-dark-border text-slate-600 dark:text-white p-2.5 rounded-lg transition-colors border border-slate-200 dark:border-dark-border"><i class="ph-bold ph-plus text-sm"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 dark:bg-dark-bg border-t border-slate-200 dark:border-dark-border flex justify-end gap-3">
                        <button onclick="window.resetUpload()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white transition-colors">Cancel</button>
                        <button onclick="window.handleUpload()" id="btn-confirm-upload" disabled class="px-6 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all">Start Upload</button>
                    </div>
                </div>
            </section>

            <!-- GALLERY VIEW -->
            <section id="view-gallery" class="hidden animate-slide-up">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Gallery</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Manage your assets.</p>
                    </div>
                    <div class="relative min-w-[200px]">
                        <select id="gallery-filter" onchange="window.renderGallery()" class="w-full bg-white dark:bg-dark-surface border border-slate-300 dark:border-dark-border text-slate-900 dark:text-white text-sm font-medium rounded-lg px-4 py-2.5 pl-10 appearance-none focus:ring-1 focus:ring-brand-500 focus:border-brand-500 outline-none shadow-sm cursor-pointer transition-all">
                            <option value="all">Show All</option>
                        </select>
                        <i class="ph-bold ph-funnel absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 z-10 text-sm"></i>
                        <i class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                    </div>
                </div>
                <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4"></div>
                <div id="gallery-locked-state" class="hidden flex flex-col items-center justify-center py-24 bg-white dark:bg-dark-surface rounded-xl border border-dashed border-red-200 dark:border-red-900/30">
                    <div class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mb-4"><i class="ph-fill ph-lock-key text-2xl"></i></div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1" id="locked-section-name">Locked</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Password required.</p>
                    <button onclick="window.requestUnlock()" class="px-6 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 shadow-sm transition-all">Unlock</button>
                </div>
                <div id="empty-gallery" class="hidden flex flex-col items-center justify-center py-24 text-center bg-white dark:bg-dark-surface rounded-xl border border-dashed border-slate-200 dark:border-dark-border">
                    <div class="w-12 h-12 bg-slate-50 dark:bg-dark-bg rounded-full flex items-center justify-center mb-4 text-slate-300 dark:text-slate-600"><i class="ph-duotone ph-image-broken text-2xl"></i></div>
                    <h3 class="text-base font-bold text-slate-900 dark:text-white">No images found</h3>
                    <p class="text-sm text-slate-500 mb-4">Upload items to this collection.</p>
                    <button onclick="window.router('upload')" class="text-brand-600 font-semibold hover:text-brand-700 text-sm">Go to Upload &rarr;</button>
                </div>
            </section>

            <!-- SECTIONS VIEW -->
            <section id="view-sections" class="hidden max-w-5xl mx-auto animate-slide-up">
                <div id="sections-root">
                    <header class="mb-8">
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Collections</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Organize and secure your content.</p>
                    </header>
                    <div class="bg-white dark:bg-dark-surface p-6 rounded-xl shadow-card border border-slate-200 dark:border-dark-border mb-8">
                        <h3 class="text-sm font-bold mb-4 flex items-center gap-2 text-slate-800 dark:text-white uppercase tracking-wide"><i class="ph-bold ph-plus-circle text-brand-600"></i> Create New</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 flex gap-3">
                                <input type="text" id="new-section-name" placeholder="Collection Name" class="flex-1 bg-slate-50 dark:bg-dark-bg border border-slate-300 dark:border-dark-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-brand-500 text-sm transition-all">
                                <button onclick="window.createSection()" class="px-6 py-2.5 bg-brand-600 text-white font-medium rounded-lg hover:bg-brand-700 transition-colors shadow-sm text-sm">Create</button>
                            </div>
                            <div class="flex items-center gap-3 border-l border-slate-200 dark:border-dark-border pl-4 md:min-w-[280px]">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="new-section-private" class="rounded text-brand-600 focus:ring-brand-500" onchange="window.togglePasswordInput()">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-1.5"><i class="ph-bold ph-lock-key"></i> Private</span>
                                </label>
                                <div id="password-input-container" class="hidden flex-1 opacity-0 transition-all duration-200">
                                    <input type="password" id="new-section-password" placeholder="Password" class="w-full bg-slate-50 dark:bg-dark-bg border border-slate-300 dark:border-dark-border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-500 text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 uppercase tracking-wide">All Collections</h3>
                    <div class="grid gap-3" id="sections-list"></div>
                </div>
                <div id="section-detail-view" class="hidden animate-slide-up">
                    <header class="mb-8 flex items-center gap-4">
                        <button onclick="window.exitSection()" class="w-10 h-10 rounded-lg bg-white dark:bg-dark-surface border border-slate-200 dark:border-dark-border text-slate-600 dark:text-white flex items-center justify-center hover:bg-slate-50 dark:hover:bg-dark-border transition-all"><i class="ph-bold ph-arrow-left text-lg"></i></button>
                        <div>
                            <h2 id="detail-section-name" class="text-2xl font-bold text-slate-900 dark:text-white">Section Name</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Collection View</p>
                        </div>
                    </header>
                    <div id="section-detail-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    <div id="section-detail-empty" class="hidden flex flex-col items-center justify-center py-20 text-center">
                         <i class="ph-duotone ph-image-square text-4xl text-slate-300 dark:text-slate-600 mb-3"></i>
                         <p class="text-sm text-slate-500 font-medium">Empty collection.</p>
                    </div>
                </div>
            </section>

            <!-- SETTINGS VIEW -->
            <section id="view-settings" class="hidden max-w-3xl mx-auto animate-slide-up">
                <header class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Settings</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Application preferences.</p>
                </header>
                <div class="bg-white dark:bg-dark-surface rounded-xl border border-slate-200 dark:border-dark-border shadow-card overflow-hidden">
                    <div class="p-6 flex items-center justify-between border-b border-slate-100 dark:border-dark-border">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-dark-bg flex items-center justify-center text-slate-600 dark:text-slate-300"><i class="ph-fill ph-moon-stars text-xl"></i></div>
                            <div>
                                <h3 class="font-semibold text-slate-900 dark:text-white">Dark Appearance</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Adjust the interface theme</p>
                            </div>
                        </div>
                        <button onclick="window.toggleTheme()" id="theme-toggle-btn" class="relative inline-flex h-7 w-12 items-center rounded-full bg-slate-200 dark:bg-brand-600 transition-colors focus:outline-none">
                            <span id="theme-toggle-dot" class="inline-block h-5 w-5 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6 shadow-sm"></span>
                        </button>
                    </div>
                    <div class="p-6 bg-slate-50/50 dark:bg-dark-bg/50 text-center">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ImageHub Pro v5.0</p>
                        <p class="text-[10px] text-slate-400">Secure Cloud Architecture</p>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- FIXED OVERLAYS MOVED OUTSIDE MAIN FOR PROPER Z-INDEXING -->
    
    <!-- Toast -->
    <div id="toast" class="fixed top-20 md:top-6 right-6 transform -translate-y-40 opacity-0 transition-all duration-300 z-[90] bg-white dark:bg-dark-surface border border-slate-200 dark:border-dark-border px-4 py-3 rounded-lg shadow-float flex items-center gap-3 font-medium min-w-[300px]">
        <div id="toast-icon-bg" class="w-6 h-6 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center flex-shrink-0">
            <i id="toast-icon" class="ph-bold ph-check text-sm"></i>
        </div>
        <span id="toast-msg" class="text-sm text-slate-800 dark:text-white">Action Successful</span>
    </div>

    <!-- Fullscreen Image Viewer -->
    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-sm flex flex-col justify-center items-center transition-all duration-300 opacity-0">
        <div class="absolute top-0 left-0 right-0 p-4 md:p-6 flex justify-between items-center z-20">
            <button onclick="window.closeImageViewer()" class="group flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/15 border border-white/5 text-white transition-all">
                <i class="ph-bold ph-arrow-left"></i> <span class="font-medium text-sm">Back</span>
            </button>
            <button id="viewer-download-btn" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/15 border border-white/5 text-white transition-all">
                <i class="ph-bold ph-download-simple text-lg"></i>
            </button>
        </div>
        <div class="w-full h-full flex items-center justify-center p-4 md:p-12" onclick="if(event.target === this) window.closeImageViewer()">
            <img id="viewer-image" src="" class="max-h-full max-w-full object-contain rounded-md shadow-2xl transition-all duration-500 scale-95 opacity-0">
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-900 to-transparent pointer-events-none">
            <div class="max-w-4xl mx-auto text-center">
                <h3 id="viewer-title" class="text-xl font-bold text-white mb-1">Image Title</h3>
                <p id="viewer-meta" class="text-slate-400 text-xs font-medium uppercase tracking-wider">Details</p>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white dark:bg-dark-surface p-6 rounded-xl shadow-2xl w-full max-w-sm border border-slate-200 dark:border-dark-border transform scale-95 transition-all duration-300 m-4">
            <div class="flex flex-col items-center mb-6">
                <div class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mb-3">
                    <i class="ph-fill ph-lock-key text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Protected Section</h3>
                <p class="text-slate-500 dark:text-slate-400 text-xs text-center mt-1">Authentication required.</p>
            </div>
            <input type="password" id="unlock-password-input" class="w-full bg-slate-50 dark:bg-dark-bg border border-slate-200 dark:border-dark-border rounded-lg px-4 py-3 mb-4 text-center text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all placeholder:text-slate-400" placeholder="Enter Password">
            <div class="flex gap-2">
                <button onclick="window.closePasswordModal()" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-dark-border transition-colors">Cancel</button>
                <button onclick="window.submitPassword()" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 shadow-sm transition-all">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="app-loader" class="fixed inset-0 bg-slate-50 dark:bg-dark-bg z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 rounded-lg bg-brand-600 flex items-center justify-center shadow-lg mb-4 animate-bounce">
            <i class="ph-bold ph-cloud text-2xl text-white"></i>
        </div>
        <p class="font-medium text-slate-500 text-xs uppercase tracking-widest">Loading Workspace</p>
    </div>

    <!-- JS Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ... Configuration ...
        let firebaseConfig;
        let isEnvironmentConfig = false;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            isEnvironmentConfig = true;
        } else {
             firebaseConfig = {
                apiKey: "AIzaSyDEJUuNeIej1KKJ2gJKHop4ezWxv3B4CC4",
                authDomain: "mvs-db-99118.firebaseapp.com",
                projectId: "mvs-db-99118",
                storageBucket: "mvs-db-99118.firebasestorage.app",
                messagingSenderId: "525394480070",
                appId: "1:525394480070:web:d28ed3f87968dec52940c7",
                measurementId: "G-G5Y154JK0F"
            };
        }

        const CLOUDINARY_CLOUD_NAME = "da6fjyirm";
        const CLOUDINARY_PRESET = "image_uploader";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ... State ...
        const defaultSections = [
            { id: 'sec_1', name: 'Photography', color: '#6366f1' }, 
            { id: 'sec_2', name: 'Design', color: '#8b5cf6' }, 
            { id: 'sec_3', name: 'Wallpapers', color: '#ec4899' }
        ];

        let appState = {
            images: [],
            sections: [],
            unlockedSections: new Set(),
            pendingUnlockId: null,
            activeSectionId: null, 
            settings: { theme: localStorage.getItem('theme') || 'light' },
            stats: { views: {} }
        };

        // ... Initialization ...
        async function init() {
            window.applyTheme(appState.settings.theme);
            try {
                if (isEnvironmentConfig && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                if (auth.currentUser) setupListeners();
            } catch (error) {
                console.error("Auth Error:", error);
                window.showToast("Connection Failed", "error");
                document.getElementById('app-loader').innerHTML = `<p class="text-red-500 font-bold">Connection Failed</p>`;
            }
        }

        function setupListeners() {
            const qSections = query(collection(db, 'artifacts', appId, 'public', 'data', 'sections'));
            onSnapshot(qSections, (snapshot) => {
                const secs = [];
                snapshot.forEach((doc) => secs.push({ id: doc.id, ...doc.data() }));
                secs.sort((a, b) => a.name.localeCompare(b.name));
                appState.sections = secs.length > 0 ? secs : defaultSections;
                renderAll();
                
                // Fix for the error
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => loader.remove(), 500);
                }
            }, (error) => {
                console.error("Error fetching sections:", error);
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.innerHTML = `<p class="text-red-500 font-bold">Connection Failed</p>`;
                } else {
                    window.showToast("Data Sync Error", "error");
                }
            });

            const qImages = query(collection(db, 'artifacts', appId, 'public', 'data', 'images'));
            onSnapshot(qImages, (snapshot) => {
                const imgs = [];
                snapshot.forEach((doc) => imgs.push({ id: doc.id, ...doc.data() }));
                imgs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                appState.images = imgs;
                renderAll();
            });
        }

        function renderAll() {
            if(!document.getElementById('view-dashboard').classList.contains('hidden')) window.renderDashboard();
            if(!document.getElementById('view-gallery').classList.contains('hidden')) window.renderGallery();
            if(!document.getElementById('view-sections').classList.contains('hidden')) window.renderSections();
            if(!document.getElementById('view-upload').classList.contains('hidden')) window.renderUploadSelects();
        }

        // ... Router ...
        window.router = function(viewId) {
            document.querySelectorAll('section[id^="view-"]').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('animate-slide-up');
            });
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const view = document.getElementById(`view-${viewId}`);
            view.classList.remove('hidden');
            void view.offsetWidth; 
            view.classList.add('animate-slide-up');
            
            // Set active state for desktop sidebar
            const deskNavBtn = document.getElementById(`desk-nav-${viewId}`);
            if(deskNavBtn) deskNavBtn.classList.add('active');

            // Set active state for mobile bottom nav
            const mobNavBtn = document.getElementById(`mob-nav-${viewId}`);
            if(mobNavBtn) mobNavBtn.classList.add('active');

            renderAll();
        }

        // Removed toggleMobileMenu as it's no longer used with bottom nav

        // ... Theme ...
        window.toggleTheme = function() {
            appState.settings.theme = appState.settings.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', appState.settings.theme);
            window.applyTheme(appState.settings.theme);
        }

        window.applyTheme = function(theme) {
            const html = document.querySelector('html');
            const dot = document.getElementById('theme-toggle-dot');
            if (theme === 'dark') {
                html.classList.add('dark');
                if(dot) { dot.classList.add('translate-x-6'); dot.classList.remove('translate-x-1'); }
            } else {
                html.classList.remove('dark');
                if(dot) { dot.classList.remove('translate-x-6'); dot.classList.add('translate-x-1'); }
            }
            renderAll();
        }

        // ... Upload ...
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        let currentFiles = [];

        dropZone.addEventListener('click', (e) => { if(e.target.closest('button') || e.target.closest('select') || e.target.closest('input')) return; fileInput.click(); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/10'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/10'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/10'); if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFileSelect(e.target.files); });

        function handleFileSelect(files) {
            let added = 0;
            Array.from(files).forEach(file => {
                 if (file.type.startsWith('image/') && !currentFiles.some(f => f.name === file.name)) {
                    currentFiles.push(file); added++;
                 }
            });
            if (added > 0) renderUploadPreview();
        }

        function renderUploadPreview() {
            const prev = document.getElementById('upload-preview');
            const holder = document.getElementById('upload-placeholder');
            const btn = document.getElementById('btn-confirm-upload');
            
            if (currentFiles.length === 0) {
                prev.classList.add('hidden'); holder.classList.remove('hidden');
                btn.disabled = true; btn.innerText = "Start Upload";
                return;
            }
            holder.classList.add('hidden'); prev.classList.remove('hidden');
            btn.disabled = false; btn.innerText = `Upload ${currentFiles.length} Item(s)`;
            document.getElementById('selected-count').innerText = currentFiles.length;

            document.getElementById('preview-list').innerHTML = currentFiles.map((file, i) => `
                <div class="relative aspect-square rounded-lg overflow-hidden group border border-slate-200 dark:border-dark-border">
                    <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover">
                    <button onclick="window.removeFile(${i}); event.stopPropagation();" class="absolute top-1 right-1 bg-white dark:bg-dark-surface text-red-500 w-5 h-5 rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-50"><i class="ph-bold ph-x text-xs"></i></button>
                </div>
            `).join('');
            
            const titleInput = document.getElementById('upload-title');
            if(!titleInput.value && currentFiles.length === 1) titleInput.value = currentFiles[0].name.split('.')[0];
        }

        window.removeFile = function(i) { currentFiles.splice(i, 1); renderUploadPreview(); }
        window.resetUpload = function() { currentFiles = []; fileInput.value = ''; document.getElementById('upload-loading').classList.add('hidden'); document.getElementById('upload-title').value = ''; renderUploadPreview(); }

        window.compressImage = function(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(1, 1000 / img.width);
                        canvas.width = img.width * scale; canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject; img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        window.handleUpload = async function() {
            if (!currentFiles.length) return;
            if (!auth.currentUser) return window.showToast("Auth Required", "error");

            document.getElementById('upload-loading').classList.remove('hidden');
            const sectionId = document.getElementById('upload-section-select').value;
            const prefix = document.getElementById('upload-title').value.trim();
            const total = currentFiles.length;
            const bar = document.getElementById('upload-progress-bar');
            const txt = document.getElementById('upload-status-text');

            for (let i = 0; i < total; i++) {
                txt.innerText = `Uploading ${i+1}/${total}`;
                bar.style.width = `${((i)/total)*100}%`;
                
                try {
                    const file = currentFiles[i];
                    let url = '', pid = '';
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_PRESET);

                    try {
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                        if(res.ok) { const d = await res.json(); url = d.secure_url; pid = d.public_id; }
                        else throw new Error('Cloudinary Error');
                    } catch(e) {
                        url = await window.compressImage(file);
                        pid = 'local_' + Date.now();
                    }

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'images'), {
                        title: (total > 1 && prefix) ? `${prefix} - ${file.name}` : (prefix || file.name.split('.')[0]),
                        sectionId: sectionId,
                        data: url,
                        publicId: pid,
                        size: file.size,
                        views: 0,
                        createdAt: serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            }
            bar.style.width = '100%';
            window.showToast("Upload Complete");
            setTimeout(() => { window.resetUpload(); window.router('gallery'); }, 800);
        }

        window.renderUploadSelects = function() {
            const el = document.getElementById('upload-section-select');
            el.innerHTML = appState.sections.length ? appState.sections.map(s => `<option value="${s.id}">${s.name}</option>`).join('') : '<option disabled>Create a section first</option>';
        }

        // --- Gallery & Sections ---
        window.renderGallery = function() {
            const grid = document.getElementById('gallery-grid');
            const filter = document.getElementById('gallery-filter');
            const locked = document.getElementById('gallery-locked-state');
            const empty = document.getElementById('empty-gallery');
            
            // --- FIX: Logic to correctly populate dropdown while preserving selection ---
            const currentVal = filter.value; 
            
            // Rebuild options every time to ensure sync with appState.sections
            const optionsHtml = `<option value="all">Show All</option>` + 
                appState.sections.map(s => `<option value="${s.id}">${s.isPrivate ? ' ' : ''}${s.name}</option>`).join('');
            
            // Only update innerHTML if it has changed to prevent cursor jumping or reset (though minor for select)
            if (filter.innerHTML !== optionsHtml) {
                filter.innerHTML = optionsHtml;
                // Restore value if valid, else default to 'all'
                if (currentVal === 'all' || appState.sections.some(s => s.id === currentVal)) {
                    filter.value = currentVal;
                } else {
                    filter.value = 'all';
                }
            }
            
            const val = filter.value;
            // --------------------------------------------------------------------------

            const sec = appState.sections.find(s => s.id === val);
            grid.classList.add('hidden'); locked.classList.add('hidden'); empty.classList.add('hidden');

            if (sec && sec.isPrivate && !appState.unlockedSections.has(sec.id)) {
                locked.classList.remove('hidden');
                document.getElementById('locked-section-name').innerText = sec.name;
                appState.pendingUnlockId = sec.id;
                return;
            }

            const images = val === 'all' 
                ? appState.images.filter(img => {
                    const s = appState.sections.find(x => x.id === img.sectionId);
                    return s && !s.isPrivate; // Hide private in ALL view
                })
                : appState.images.filter(img => img.sectionId === val);

            if (!images.length) { empty.classList.remove('hidden'); return; }

            grid.classList.remove('hidden');
            grid.innerHTML = images.map((img, i) => {
                const s = appState.sections.find(x => x.id === img.sectionId) || {name:'Unknown'};
                return window.createImageCard(img, i, s.name);
            }).join('');
        }

        window.createImageCard = function(img, i, sName) {
            return `
            <div class="bg-white dark:bg-dark-surface rounded-lg overflow-hidden border border-slate-200 dark:border-dark-border shadow-card hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 group cursor-pointer animate-slide-up" style="animation-delay: ${i*50}ms" onclick="window.viewImage('${img.id}')">
                <div class="aspect-[4/3] bg-slate-100 dark:bg-dark-bg relative overflow-hidden">
                    <img src="${img.data}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                        <button onclick="event.stopPropagation(); window.viewImage('${img.id}')" class="w-8 h-8 bg-white text-slate-900 rounded-md flex items-center justify-center hover:bg-slate-100 transition-colors shadow-sm"><i class="ph-bold ph-eye"></i></button>
                        <button onclick="event.stopPropagation(); window.downloadImage('${img.id}')" class="w-8 h-8 bg-white text-emerald-600 rounded-md flex items-center justify-center hover:bg-emerald-50 transition-colors shadow-sm"><i class="ph-bold ph-download-simple"></i></button>
                        <button onclick="event.stopPropagation(); window.deleteImage('${img.id}')" class="w-8 h-8 bg-white text-red-500 rounded-md flex items-center justify-center hover:bg-red-50 transition-colors shadow-sm"><i class="ph-bold ph-trash"></i></button>
                    </div>
                    <span class="absolute top-2 left-2 px-2 py-0.5 bg-black/50 backdrop-blur-sm rounded text-[10px] font-medium text-white">${sName}</span>
                </div>
                <div class="p-3">
                    <h4 class="font-semibold text-sm text-slate-900 dark:text-white truncate">${img.title}</h4>
                    <div class="flex justify-between items-center text-[10px] text-slate-500 dark:text-slate-400 mt-1">
                        <span class="font-medium">${window.formatBytes(img.size)}</span>
                        <span>${new Date(img.createdAt?.seconds*1000).toLocaleDateString()}</span>
                    </div>
                </div>
            </div>`;
        }

        window.renderSections = function() {
            if (appState.activeSectionId) {
                // Detail View
                document.getElementById('sections-root').classList.add('hidden');
                document.getElementById('section-detail-view').classList.remove('hidden');
                const sec = appState.sections.find(s => s.id === appState.activeSectionId);
                if(sec) {
                    document.getElementById('detail-section-name').innerText = sec.name;
                    const imgs = appState.images.filter(i => i.sectionId === sec.id);
                    const grid = document.getElementById('section-detail-grid');
                    const empty = document.getElementById('section-detail-empty');
                    if(!imgs.length) { grid.innerHTML = ''; empty.classList.remove('hidden'); }
                    else { empty.classList.add('hidden'); grid.innerHTML = imgs.map((img, i) => window.createImageCard(img, i, sec.name)).join(''); }
                }
                return;
            }
            // List View
            document.getElementById('sections-root').classList.remove('hidden');
            document.getElementById('section-detail-view').classList.add('hidden');
            document.getElementById('sections-list').innerHTML = appState.sections.map((s, i) => `
                <div onclick="window.openSection('${s.id}')" class="bg-white dark:bg-dark-surface p-4 rounded-lg border border-slate-200 dark:border-dark-border flex items-center justify-between cursor-pointer hover:border-brand-300 dark:hover:border-brand-700 transition-all group animate-slide-up" style="animation-delay: ${i*50}ms">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-sm" style="background-color: ${s.color};">
                            ${s.isPrivate ? '<i class="ph-fill ph-lock-key text-white/90"></i>' : s.name[0]}
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm text-slate-900 dark:text-white group-hover:text-brand-600 transition-colors">${s.name}</h4>
                            <p class="text-xs text-slate-500 font-medium">${appState.images.filter(x => x.sectionId === s.id).length} Files</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); window.deleteSection('${s.id}')" class="w-8 h-8 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-400 hover:text-red-500 flex items-center justify-center transition-colors"><i class="ph-bold ph-trash"></i></button>
                        <i class="ph-bold ph-caret-right text-slate-400 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            `).join('');
        }

        window.openSection = function(id) {
            const s = appState.sections.find(x => x.id === id);
            if(s.isPrivate && !appState.unlockedSections.has(id)) {
                appState.pendingUnlockId = id; appState.activeSectionId = id; window.requestUnlock(id);
            } else {
                appState.activeSectionId = id; window.renderSections();
            }
        }
        window.exitSection = function() { appState.activeSectionId = null; window.renderSections(); }

        window.togglePasswordInput = function() {
            const show = document.getElementById('new-section-private').checked;
            const el = document.getElementById('password-input-container');
            if(show) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); }
            else { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); }
        }

        window.createSection = async function() {
            if (!auth.currentUser) return window.showToast("Auth Required", "error");
            const name = document.getElementById('new-section-name').value.trim();
            const priv = document.getElementById('new-section-private').checked;
            const pass = document.getElementById('new-section-password').value;
            if(!name) return;
            if(priv && !pass) return window.showToast("Password required", "error");

            const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#f43f5e'];
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sections'), {
                name, color: colors[Math.floor(Math.random()*colors.length)], isPrivate: priv, password: pass
            });
            window.showToast("Collection Created");
            document.getElementById('new-section-name').value = '';
            document.getElementById('new-section-password').value = '';
            document.getElementById('new-section-private').checked = false;
            window.togglePasswordInput();
        }

        window.deleteSection = async function(id) {
            if (!auth.currentUser) return;
            if(appState.images.some(x => x.sectionId === id)) return window.showToast("Section not empty", "error");
            if(confirm('Delete this collection permanently?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sections', id));
                window.showToast("Deleted");
            }
        }

        // ... Viewer & Download ...
        window.viewImage = function(id) {
            const img = appState.images.find(x => x.id === id);
            if(!img) return;
            const v = document.getElementById('image-viewer-modal');
            const vi = document.getElementById('viewer-image');
            vi.src = img.data;
            document.getElementById('viewer-title').innerText = img.title;
            document.getElementById('viewer-meta').innerText = `${window.formatBytes(img.size)}  ${new Date(img.createdAt?.seconds*1000).toLocaleDateString()}`;
            document.getElementById('viewer-download-btn').onclick = () => window.downloadImage(id);
            v.classList.remove('hidden');
            setTimeout(() => { v.classList.remove('opacity-0'); vi.classList.remove('scale-95', 'opacity-0'); }, 10);
        }
        window.closeImageViewer = function() {
            const v = document.getElementById('image-viewer-modal');
            const vi = document.getElementById('viewer-image');
            v.classList.add('opacity-0'); vi.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { v.classList.add('hidden'); vi.src=''; }, 300);
        }

        window.downloadImage = async function(id) {
            const img = appState.images.find(x => x.id === id);
            if(!img) return;
            window.showToast("Preparing Download...");
            try {
                const res = await fetch(img.data);
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${img.title.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                window.showToast("Download Started");
            } catch(e) {
                window.open(img.data, '_blank');
            }
        }

        window.deleteImage = async function(id) {
            if(confirm("Permanently delete this image?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'images', id));
        }

        // ... Password Modal ...
        window.requestUnlock = function(id) {
            const m = document.getElementById('password-modal');
            const inp = document.getElementById('unlock-password-input');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('div').classList.remove('scale-95'); inp.focus(); }, 10);
            inp.onkeydown = (e) => { if(e.key === 'Enter') window.submitPassword(); }
        }
        window.closePasswordModal = function() {
            const m = document.getElementById('password-modal');
            m.classList.add('opacity-0');
            m.querySelector('div').classList.add('scale-95');
            setTimeout(() => { m.classList.add('hidden'); document.getElementById('unlock-password-input').value = ''; }, 300);
        }
        window.submitPassword = function() {
            const pass = document.getElementById('unlock-password-input').value;
            const sec = appState.sections.find(s => s.id === appState.pendingUnlockId);
            if(sec && sec.password === pass) {
                appState.unlockedSections.add(sec.id);
                window.closePasswordModal();
                if(appState.activeSectionId === sec.id) window.openSection(sec.id);
                else window.renderGallery();
                window.showToast("Section Unlocked");
            } else {
                window.showToast("Incorrect Password", "error");
            }
        }

        // ... Charts & Utils ...
        let viewsChart = null, storageChart = null;
        window.renderDashboard = function() {
            document.getElementById('stat-total-images').innerText = appState.images.length;
            const totalViews = appState.images.reduce((a, b) => a + (b.views || 0), 0);
            document.getElementById('stat-total-views').innerText = totalViews;
            const totalSize = appState.images.reduce((a, b) => a + b.size, 0);
            document.getElementById('stat-storage').innerText = window.formatBytes(totalSize);
            document.getElementById('stat-sections').innerText = appState.sections.length;
            document.getElementById('storage-text').innerText = window.formatBytes(totalSize);
            window.renderCharts(totalViews);
        }

        window.renderCharts = function(views) {
            const ctx1 = document.getElementById('viewsChart');
            const ctx2 = document.getElementById('storageChart');
            if(viewsChart) viewsChart.destroy();
            if(storageChart) storageChart.destroy();
            
            const isDark = appState.settings.theme === 'dark';
            const color = isDark ? '#94a3b8' : '#64748b';

            viewsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Views',
                        data: Array(7).fill(0).map(() => Math.floor(Math.random() * (views/2 || 10))),
                        borderColor: '#6366f1',
                        backgroundColor: (ctx) => {
                            const grad = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                            grad.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
                            grad.addColorStop(1, 'rgba(99, 102, 241, 0)');
                            return grad;
                        },
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { display: false }, ticks: { color, font: {family: 'Inter'} } },
                        x: { grid: { display: false }, ticks: { color, font: {family: 'Inter'} } }
                    }
                }
            });

            const sizes = appState.sections.map(s => appState.images.filter(i => i.sectionId === s.id).reduce((a,b) => a+b.size, 0));
            document.getElementById('chart-center-text').innerText = window.formatBytes(sizes.reduce((a,b)=>a+b,0));

            storageChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: appState.sections.map(s => s.name),
                    datasets: [{
                        data: sizes.length ? sizes : [1],
                        backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.formatBytes = (bytes) => {
            if(!+bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
        }

        window.showToast = (msg, type='success') => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            const bg = document.getElementById('toast-icon-bg');
            
            if(type === 'error') {
                bg.className = 'w-6 h-6 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 flex items-center justify-center flex-shrink-0';
                icon.className = 'ph-bold ph-warning-circle text-sm';
            } else {
                bg.className = 'w-6 h-6 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center flex-shrink-0';
                icon.className = 'ph-bold ph-check text-sm';
            }
            
            t.classList.remove('-translate-y-40', 'opacity-0');
            setTimeout(() => t.classList.add('-translate-y-40', 'opacity-0'), 3000);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
